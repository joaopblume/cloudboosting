{% extends 'base.html' %}

{% block content %}
<div class="min-h-screen bg-orange-500 flex justify-center items-center">
    <div class="bg-white rounded-lg shadow-lg w-11/12 max-w-4xl p-8">
        <h1 class="text-2xl font-bold text-gray-800 mb-6 text-center">Schedule Timeline</h1>

        <!-- Linha do Tempo -->
        <div id="timeline-container" 
            class="relative w-full h-8 bg-gray-200 rounded-lg overflow-visible"
            style="background: 
                repeating-linear-gradient(
                    to right,
                    transparent, 
                    transparent calc((100% / 24) - 1px),
                    rgb(189, 187, 187) calc((100% / 24) - 1px),
                    rgb(189, 187, 187) calc(100% / 24)
                ),
                #ffdd9dce;">
                
            <div id="timeline" class="relative h-full">
                <!-- Os pontos clicados aparecerÃ£o aqui -->
            </div>
                <!-- Elipse de Zoom -->
            <div id="zoom-display" 
                class="absolute hidden justify-center items-center bg-white text-black text-sm font-bold rounded-full shadow-lg border border-gray-300"
                style="width: 50px; height: 70px; transform: translate(-50%, -150%); z-index: 10; ">
            </div>
        </div>

        <!-- MarcaÃ§Ã£o das Horas -->
        <div id="hour-marks" class="flex text-gray-800 text-xs mt-2 relative">
            {% for hour in hours %}
            <div class="absolute" style="left: calc(({{ forloop.counter0 }} * 100%) / 24); transform: translateX(-50%);">
                {{ hour }}h
            </div>
            {% endfor %}
        </div>
        <p class="text-gray-600 text-center mt-4 pt-12">Click on the timeline to add state points (On/Off).</p>

        <!-- Legenda -->
        <div class="flex justify-center items-center mt-6 space-x-4">
            <div class="flex items-center space-x-2">
                <div class="w-4 h-4 bg-green-500 rounded-full ';"></div>
                <span class="text-gray-800 font-semibold">On</span>
            </div>
            <div class="flex items-center space-x-2">
                <div class="w-4 h-4 bg-red-500 rounded-full"></div>
                <span class="text-gray-800 font-semibold">Off</span>
            </div>
        </div>

        <!-- BotÃµes -->
        <div class="flex justify-end space-x-4 mt-6">
            <button type="button" id="clear-timeline" class="bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded-lg font-bold transition duration-300 flex items-center space-x-2">
                <span>ðŸ§¹</span>
                <span>Limpar</span>
            </button>
        </div>
        <div class="flex justify-end space-x-4 mt-8">
            <form method="post" action="{% url 'agendar_vm' instance_id=instance_id %}">
                {% csrf_token %}
                <input type="hidden" name="intervals" id="intervals-data">
                <button type="submit" class="bg-blue-500 hover:bg-blue-600 text-white px-6 py-2 rounded-lg font-bold transition duration-300">
                    Submit
                </button>
            </form>
            <button type="button" class="bg-gray-300 hover:bg-gray-400 text-gray-800 px-6 py-2 rounded-lg font-bold transition duration-300">
                Cancel
            </button>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function () {
    const timelineContainer = document.getElementById('timeline-container');
    const timeline = document.getElementById('timeline');
    const zoomDisplay = document.getElementById('zoom-display'); // Elipse de Zoom
    let draggedPoint = null;
    let isDragging = false;

    // Clique para criar pontos
    timelineContainer.addEventListener('click', function (event) {
        const rect = timelineContainer.getBoundingClientRect();
        const position = ((event.clientX - rect.left) / rect.width) * 100; // PosiÃ§Ã£o em %

        // Impedir criaÃ§Ã£o de pontos muito prÃ³ximos
        const existingPoint = Array.from(timeline.children).find(point => Math.abs(parseFloat(point.style.left) - position) < 2);
        if (existingPoint) return;

        const newPoint = document.createElement('div');
        newPoint.className = 'absolute bg-green-500 w-4 h-4 rounded-full cursor-pointer';
        newPoint.style.left = `${position}%`;
        newPoint.style.top = '50%';
        newPoint.style.top = '50%'; // Centraliza verticalmente
        newPoint.style.border = '2px solid white'; // Adiciona a borda branca
        newPoint.style.transform = 'translate(-50%, -50%)'; // Ajuste refinado
        newPoint.setAttribute('data-state', 'on');
        timeline.appendChild(newPoint);

        // Alternar estado ao clicar
        newPoint.addEventListener('click', function (e) {
            if (!isDragging) {
                e.stopPropagation();
                const state = newPoint.getAttribute('data-state');
                if (state === 'on') {
                    newPoint.classList.remove('bg-green-500');
                    newPoint.classList.add('bg-red-500');
                    newPoint.setAttribute('data-state', 'off');
                } else {
                    newPoint.classList.remove('bg-red-500');
                    newPoint.classList.add('bg-green-500');
                    newPoint.setAttribute('data-state', 'on');
                }
            }
        });

        // Permitir arrastar o ponto
        newPoint.addEventListener('mousedown', function (e) {
            draggedPoint = newPoint;
            //Mostra a elipse
            isDragging = false; // Reinicia a flag
        });
    });

    // Movimentar o ponto enquanto o mouse estiver pressionado
    timelineContainer.addEventListener('mousemove', function (event) {
        if (draggedPoint) {
            isDragging = true; // Indica que o ponto estÃ¡ sendo arrastado
            const rect = timelineContainer.getBoundingClientRect();
            const positionX = ((event.clientX - rect.left) / rect.width) * 100;

            if (positionX >= 0 && positionX <= 100) {
                draggedPoint.style.left = `${positionX}%`;
                // Calcular posiÃ§Ã£o em minutos
                const totalMinutes = Math.round((positionX / 100) * 1440); // 1440 minutos = 24h
                const roundedMinutes = Math.round(totalMinutes); // Arredonda para mÃºltiplos de 15 minutos

                // Converter minutos para HH:mm
                const hours = Math.floor(roundedMinutes / 60);
                const minutes = roundedMinutes % 60;
                const time = `${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}`;

                zoomDisplay.textContent = time;
                zoomDisplay.style.left = `${positionX}%`;
                zoomDisplay.style.display = "flex";
                zoomDisplay.style.alignItems = "center";
                zoomDisplay.style.justifyContent = "center";
                zoomDisplay.style.lineHeight = "1"; // Adiciona espaÃ§amento consistente
                zoomDisplay.classList.remove('hidden'); // Exibe a elipse
            
            }
        }
        else {
            zoomDisplay.style.display = ""; // Remove o display inline
            zoomDisplay.classList.add('hidden'); // Oculta a elipse
        }
    });

    // Finalizar o arrasto ao soltar o mouse
    document.addEventListener('mouseup', function () {
        draggedPoint = null;

        // Adiciona um pequeno atraso para evitar que "click" seja acionado imediatamente apÃ³s o drag
        setTimeout(() => {
            isDragging = false;
        }, 50);
    });

    document.getElementById('clear-timeline').addEventListener('click', function () {
        const timeline = document.getElementById('timeline');
        while (timeline.firstChild) {
            timeline.removeChild(timeline.firstChild); // Remove todos os pontos
        }
        console.log('Timeline cleared.');
        
    });

    document.getElementById('submit-schedule').addEventListener('click', function () {
        const points = Array.from(document.querySelectorAll('#timeline > div'));
        const intervals = [];

        points.sort((a, b) => parseFloat(a.style.left) - parseFloat(b.style.left));

        let currentInterval = null;

        points.forEach(point => {
            const state = point.getAttribute('data-state');
            const positionX = parseFloat(point.style.left);
            const totalMinutes = Math.round((positionX / 100) * 1440);
            const hours = Math.floor(totalMinutes / 60);
            const minutes = totalMinutes % 60;
            const time = `${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}`;

            if (state === 'on') {
                currentInterval = { inicio: time };
            } else if (state === 'off' && currentInterval) {
                currentInterval.fim = time;
                intervals.push(currentInterval);
                currentInterval = null;
            }
        });

        const intervalsField = document.getElementById('intervals-data');
        intervalsField.value = JSON.stringify(intervals);

        console.log('Intervalos Enviados:', intervals); // Log para verificar os dados gerados
    });
});

</script>
{% endblock %}
